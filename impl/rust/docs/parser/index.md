# parser モジュール

## MemoizationMap 構造体

メモ化されたデータを持つマップ。

キーはグループUUID, 入力位置のタプル、値は進んだ入力位置の長さ, 結果のノード要素のタプル

## SyntaxParser 構造体

構文パースを行う。

構造体フィールド:

- コンソール `cons`
- パース済みの規則マップ `rule_map`
- 入力位置 `src_i`
- 入力位置 (行数) `src_line`
- 最新の改行の位置 `src_latest_line_i`
- 入力ファイルのパス `src_path`
- 入力ファイルの内容 `src_content`
-  `loop_limit`
- 引数マップ `arg_maps`
- パースされた規則の履歴 `rule_stack`
- 正規表現のキャッシュ `regex_map`
- メモ化マップ `memoized_map`
- メモ化を有効にするかどうか `enable_memoization`

### パースアルゴリズム

パースを行う関数毎に対象と処理を列挙する:

|番号 \*1|対象要素|対象|呼び出し先 \*2|特記事項|
|:-:|:-:|:-:|:-|:-:|
|1|規則|-|↓|-|
|2|通常グループ|-|↓|ここでメモ化処理|
|3|グループ|先読み|↓|-|
|4|グループ|繰り返し|↓|-|
|5|グループ|要素順|↓ もしくは 2|-|
|6|生グループ|-|↓ もしくは 2|-|
|7|通常表現字句|-|↓|-|
|8|表現字句|先読み|↓|-|
|9|表現字句|繰り返し|↓ もしくは なし|-|
|10|生表現字句|-|↓ もしくは 2 か なし|-|
|11|通常 ID 表現字句|-|→ 1|-|

パース用関数の名前は `parse_<TARGET>` で命名される。

生要素 (生グループ, 生表現字句) ... 繰り返しや先読み等を考慮しない場合の要素

[\*1] 解説上の番号
[\*2] `↓` は下項目の関数を呼び出す; `→` はある番号の関数を呼び出す

### 規則パース

`parse_rule()`

`parse_group()` で規則が持つグループを検査し、成功すれば結果のツリー要素、失敗すれば None を返す

成功した場合は AST 反映方式に応じてツリー要素を返す。

### 基本グループパース

`parse_group()`

`parse_lookahead_group()` でグループ (先読み) の検査を開始するか、メモ化データを取得してその結果を返す。

### メモ化処理

メモ化データの有無はグループ UUID 及び入力位置が `memoized_map` であるキーの存在により判断する。

- メモ化が有効な場合:
    - メモ化データがある場合:
        - メモ化された値を基に入力位置を進めてノード要素を返す
    - そうでない場合:
        - `parse_lookahead_group()` でグループを検査してその結果を返す
        - `memoized_map` に結果データを挿入する
- そうでない場合:
    - `parse_lookahead_group()` でグループを検査してその結果を返す

### グループパース (先読み)

`parse_lookahead_group`

`parse_loop_group` の結果を返す

ただし先読みが設定されている場合は入力位置を検査前に戻す。

### グループパース (繰り返し)

`parse_loop_group`

`children` ... 結果として返すための一時的なツリー要素リスト

入力文字列の長さを超えない限り `parse_element_order_group()` でグループ (要素順) の検査をループする

その際、出現回数カウントが制限を超えれば `TooLongRepetition` エラーを出す。

ループ毎での処理:

- 検査が成功した場合:
    - `children` に結果の要素を追加する
    - 繰り返しの上限が出現回数カウントと一致すれば結果を返す
- そうでない場合: \[1]
    - 出現回数カウントが繰り返し範囲内である場合:
        - グループ (要素順) の検査結果を返す
    - そうでない場合:
        - バックトラック (入力位置を検査前に戻す) して `None` を返す

ループを抜けた場合は \[1] と同じ処理を行う。

### グループパース (要素順)

`parse_element_order_group`

`children` ... 結果として返すための一時的なツリー要素リスト

- 逐次的である場合: `parse_raw_group` の検査結果を返す
- 順不同的である場合: 以下の処理を行う

#### 順不同処理

すべての対象グループが順を問わず一回ずつ出現すれば検査が成功する。

`children` ... 結果として返すための一時的なツリー要素リスト

対象グループがそれぞれ成功したかを表す `subgroup_matching_list` を用意する。

初期値はすべて `false` であり、例えば 0 番目の対象グループが成功すれば `subgroup_matching_list[0]` に `true` が代入される。

検査では対象要素の数だけループし、その中で対象グループリストをイテレートする。

その際、順不同の繰り返しが指定されていれば、対象グループに通常の繰り返し数を設定する。

### 生グループパース

逐次的なグループ (選択もしくは連接) をパースする。

`children` ... 結果として返すための一時的なツリー要素リスト

各サブ要素を `parse_group` でパースする。

- 選択の場合: グループのサブ要素を順にパースし、一度でも失敗すれば `None` を返す
- 連接の場合: グループのサブ要素を順にパースし、成功した時点で `Some` を返すが、一度も成功しなければ `None` を返す

### 基本表現字句パース

`parse_expression`

`parse_lookahead_expression` の結果を返す。

### 表現字句パース (先読み)

`parse_lookahead_expression`

基本的に [parse_group](#基本グループパース) と同様の処理を行う。

ただし関数は `parse_loop_expression` を呼び出す。

### 表現字句パース (繰り返し)

`parse_loop_expression`

基本的に [parse_group](#グループパース%20(繰り返し)) と同様の処理を行う。

ただし関数は `parse_raw_expression` を呼び出す。

### 生表現字句パース

`parse_raw_expression`

字句表現の種類により処理内容が異なる。

#### 引数 ID

対象グループを取得して `parse_group` の検査結果を返す。

#### 文字クラス

入力文字列サイズが入力位置 \+ 文字列サイズ (1) を超えれば失敗する。

正規表現マップから該当する Regex インスタンスを取得し、入力とマッチすれば成功、しなければ失敗する。

その際、入力文字列を文字列サイズ分 (1) 進める。

#### ID

ジェネリクス, テンプレートの引数指定がなければ `parse_id_expression` の結果を返す。

プリミティブ規則 (仮称) であればそれ毎の処理を行い、結果を返す。

- ジェネリクスの場合: 引数マップを追加する
- テンプレートの場合: <設計変更中のため省略>

その際、引数の数が検査先の規則と数と合わなければエラーを出す。

#### 文字列

入力文字列サイズが入力位置 \+ 文字列サイズ (n) を超えれば失敗する。

入力とマッチすれば成功、しなければ失敗する。

その際、入力文字列を文字列サイズ分 (n) 進める。

#### ワイルドカード

入力文字列サイズが入力位置 \+ 文字列サイズ (1) を超えれば失敗する。

入力文字列を文字列サイズ分 (1) 進め、条件に関わらず成功する。

### ID 表現字句パース

`parse_id_expression`

ID 表現字句をパースする。

`parse_rule` を検査し、

- 成功すれば AST 反映方式を基にノード要素を生成して `Some` を返す
- 失敗すれば `None` を返す。
